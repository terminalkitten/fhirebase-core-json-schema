
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "postgres-json-schema";

DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'resource_status') THEN
       CREATE TYPE resource_status AS ENUM ('created', 'updated', 'deleted', 'recreated');
    END IF;
END
$$;


CREATE TABLE IF NOT EXISTS "patient" (
  id text primary key,
  txid bigint not null,
  ts timestamptz DEFAULT current_timestamp,
  resource_type text default 'Patient',
  status resource_status not null,
  resource jsonb not null
);

-- SET Json schema as CONSTRAINT on patient <resource>

ALTER TABLE patient DROP CONSTRAINT IF EXISTS resource_is_valid;
ALTER TABLE patient ADD CONSTRAINT resource_is_valid CHECK (validate_json_schema('{"allOf":[{"$ref":"DomainResource#/definitions/DomainResource"},{"description":"Demographics and other administrative information about an individual or animal receiving care or other health-related services.","properties":{"resourceType":{"description":"This is a Patient resource","type":"string","enum":["Patient"]},"identifier":{"description":"An identifier for this patient.","type":"array","items":{"$ref":"Identifier.schema.json#/definitions/Identifier"}},"active":{"description":"Whether this patient record is in active use.","type":"boolean"},"_active":{"description":"Extensions for active","$ref":"Element.schema.json#/definitions/Element"},"name":{"description":"A name associated with the individual.","type":"array","items":{"$ref":"HumanName.schema.json#/definitions/HumanName"}},"telecom":{"description":"A contact detail (e.g. a telephone number or an email address) by which the individual may be contacted.","type":"array","items":{"$ref":"ContactPoint.schema.json#/definitions/ContactPoint"}},"gender":{"description":"Administrative Gender - the gender that the patient is considered to have for administration and record keeping purposes.","enum":["male","female","other","unknown"],"type":"string"},"_gender":{"description":"Extensions for gender","$ref":"Element.schema.json#/definitions/Element"},"birthDate":{"description":"The date of birth for the individual.","type":"string","pattern":"-?[0-9]{4}(-(0[1-9]|1[0-2])(-(0[0-9]|[1-2][0-9]|3[0-1]))?)?"},"_birthDate":{"description":"Extensions for birthDate","$ref":"Element.schema.json#/definitions/Element"},"deceasedBoolean":{"description":"Indicates if the individual is deceased or not.","type":"boolean"},"_deceasedBoolean":{"description":"Extensions for deceasedBoolean","$ref":"Element.schema.json#/definitions/Element"},"deceasedDateTime":{"description":"Indicates if the individual is deceased or not.","pattern":"-?[0-9]{4}(-(0[1-9]|1[0-2])(-(0[0-9]|[1-2][0-9]|3[0-1])(T([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9](\\.[0-9]+)?(Z|(\\+|-)((0[0-9]|1[0-3]):[0-5][0-9]|14:00)))?)?)?","type":"string"},"_deceasedDateTime":{"description":"Extensions for deceasedDateTime","$ref":"Element.schema.json#/definitions/Element"},"address":{"description":"Addresses for the individual.","type":"array","items":{"$ref":"Address.schema.json#/definitions/Address"}},"maritalStatus":{"description":"This field contains a patient\u0027s most recent marital (civil) status.","$ref":"CodeableConcept.schema.json#/definitions/CodeableConcept"},"multipleBirthBoolean":{"description":"Indicates whether the patient is part of a multiple (bool) or indicates the actual birth order (integer).","type":"boolean"},"_multipleBirthBoolean":{"description":"Extensions for multipleBirthBoolean","$ref":"Element.schema.json#/definitions/Element"},"multipleBirthInteger":{"description":"Indicates whether the patient is part of a multiple (bool) or indicates the actual birth order (integer).","pattern":"-?([0]|([1-9][0-9]*))","type":"number"},"_multipleBirthInteger":{"description":"Extensions for multipleBirthInteger","$ref":"Element.schema.json#/definitions/Element"},"photo":{"description":"Image of the patient.","type":"array","items":{"$ref":"Attachment.schema.json#/definitions/Attachment"}},"contact":{"description":"A contact party (e.g. guardian, partner, friend) for the patient.","type":"array","items":{"$ref":"#/definitions/Patient_Contact"}},"animal":{"description":"This patient is known to be an animal.","$ref":"#/definitions/Patient_Animal"},"communication":{"description":"Languages which may be used to communicate with the patient about his or her health.","type":"array","items":{"$ref":"#/definitions/Patient_Communication"}},"generalPractitioner":{"description":"Patient\u0027s nominated care provider.","type":"array","items":{"$ref":"Reference.schema.json#/definitions/Reference"}},"managingOrganization":{"description":"Organization that is the custodian of the patient record.","$ref":"Reference.schema.json#/definitions/Reference"},"link":{"description":"Link to another patient resource that concerns the same actual patient.","type":"array","items":{"$ref":"#/definitions/Patient_Link"}}},"required":["resourceType"]}]}', resource));

-- VALID
INSERT INTO patient (id, txid, status, resource) VALUES (uuid_generate_v4()::text, 1, 'created','{"resourceType":"Patient","id":"pat1","text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\">\n      \n      <p>Patient Donald DUCK @ Acme Healthcare, Inc. MR = 654321</p>\n    \n    </div>"},"identifier":[{"use":"usual","type":{"coding":[{"system":"http://hl7.org/fhir/v2/0203","code":"MR"}]},"system":"urn:oid:0.1.2.3.4.5.6.7","value":"654321"}],"active":true,"name":[{"use":"official","family":"Donald","given":["Duck"]}],"gender":"male","photo":[{"contentType":"image/gif","data":"R0lGODlhEwARAPcAAAAAAAAA/+9aAO+1AP/WAP/eAP/eCP/eEP/eGP/nAP/nCP/nEP/nIf/nKf/nUv/nWv/vAP/vCP/vEP/vGP/vIf/vKf/vMf/vOf/vWv/vY//va//vjP/3c//3lP/3nP//tf//vf///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////yH5BAEAAAEALAAAAAATABEAAAi+AAMIDDCgYMGBCBMSvMCQ4QCFCQcwDBGCA4cLDyEGECDxAoAQHjxwyKhQAMeGIUOSJJjRpIAGDS5wCDly4AALFlYOgHlBwwOSNydM0AmzwYGjBi8IHWoTgQYORg8QIGDAwAKhESI8HIDgwQaRDI1WXXAhK9MBBzZ8/XDxQoUFZC9IiCBh6wEHGz6IbNuwQoSpWxEgyLCXL8O/gAnylNlW6AUEBRIL7Og3KwQIiCXb9HsZQoIEUzUjNEiaNMKAAAA7"}],"contact":[{"relationship":[{"coding":[{"system":"http://hl7.org/fhir/v2/0131","code":"E"}]}],"organization":{"reference":"Organization/1","display":"Walt Disney Corporation"}}],"managingOrganization":{"reference":"Organization/1","display":"ACME Healthcare, Inc"},"link":[{"other":{"reference":"Patient/pat2"},"type":"seealso"}]}');

-- FAIL - gender is 'bird'
INSERT INTO patient (id, txid, status, resource) VALUES ('fail', 1, 'created','{"resourceType":"Patient","id":"pat1","text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\">\n      \n      <p>Patient Donald DUCK @ Acme Healthcare, Inc. MR = 654321</p>\n    \n    </div>"},"identifier":[{"use":"usual","type":{"coding":[{"system":"http://hl7.org/fhir/v2/0203","code":"MR"}]},"system":"urn:oid:0.1.2.3.4.5.6.7","value":"654321"}],"active":true,"name":[{"use":"official","family":"Donald","given":["Duck"]}],"gender":"bird","photo":[{"contentType":"image/gif","data":"R0lGODlhEwARAPcAAAAAAAAA/+9aAO+1AP/WAP/eAP/eCP/eEP/eGP/nAP/nCP/nEP/nIf/nKf/nUv/nWv/vAP/vCP/vEP/vGP/vIf/vKf/vMf/vOf/vWv/vY//va//vjP/3c//3lP/3nP//tf//vf///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////yH5BAEAAAEALAAAAAATABEAAAi+AAMIDDCgYMGBCBMSvMCQ4QCFCQcwDBGCA4cLDyEGECDxAoAQHjxwyKhQAMeGIUOSJJjRpIAGDS5wCDly4AALFlYOgHlBwwOSNydM0AmzwYGjBi8IHWoTgQYORg8QIGDAwAKhESI8HIDgwQaRDI1WXXAhK9MBBzZ8/XDxQoUFZC9IiCBh6wEHGz6IbNuwQoSpWxEgyLCXL8O/gAnylNlW6AUEBRIL7Og3KwQIiCXb9HsZQoIEUzUjNEiaNMKAAAA7"}],"contact":[{"relationship":[{"coding":[{"system":"http://hl7.org/fhir/v2/0131","code":"E"}]}],"organization":{"reference":"Organization/1","display":"Walt Disney Corporation"}}],"managingOrganization":{"reference":"Organization/1","display":"ACME Healthcare, Inc"},"link":[{"other":{"reference":"Patient/pat2"},"type":"seealso"}]}');